From 4fa4f6e32c681d08e387e882fbfd15a90b017ebc Mon Sep 17 00:00:00 2001
From: "lauren n. liberda" <lauren@selfisekai.rocks>
Date: Tue, 2 Jul 2024 04:17:52 +0200
Subject: [PATCH] PA: check for <sys/ifunc.h> to enable MTE/BTI

Bug: 40244829
---
 .../src/partition_alloc/page_allocator_internals_posix.cc    | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/base/allocator/partition_allocator/src/partition_alloc/page_allocator_internals_posix.cc b/base/allocator/partition_allocator/src/partition_alloc/page_allocator_internals_posix.cc
index 295d0cebc2a03..84e84f241c009 100644
--- a/base/allocator/partition_allocator/src/partition_alloc/page_allocator_internals_posix.cc
+++ b/base/allocator/partition_allocator/src/partition_alloc/page_allocator_internals_posix.cc
@@ -8,8 +8,9 @@
 #include "partition_alloc/buildflags.h"
 #include "partition_alloc/page_allocator.h"
 
-#if PA_BUILDFLAG(HAS_MEMORY_TAGGING) || \
-    (defined(__ARM_FEATURE_BTI_DEFAULT) && (__ARM_FEATURE_BTI_DEFAULT == 1))
+#if PA_BUILDFLAG(HAS_MEMORY_TAGGING) ||                                        \
+    (defined(__ARM_FEATURE_BTI_DEFAULT) && (__ARM_FEATURE_BTI_DEFAULT == 1) && \
+     __has_include(<sys/ifunc.h>))
 struct __ifunc_arg_t;
 
 #include "partition_alloc/aarch64_support.h"
